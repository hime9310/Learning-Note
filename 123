function prompt {
    Write-Host
    Write-Host (Get-Date -format "yyyy/MM/dd HH:mm") -ForegroundColor Green -NoNewline
    Write-Host (" | " + $env:username + "@" + ([Net.Dns]::GetHostName())) -ForegroundColor Yellow -NoNewline
    # Write-Host (" | " + (Split-Path (Get-Location) -Leaf)) -ForegroundColor Magenta  # 相対パスにしたい場合
    Write-Host (" | " + (Get-Location).Path) -ForegroundColor Magenta  # 絶対パス
    return "PS > "
}

# Terraformコマンドを上書きする関数の定義
function Terraform {
    param (
        [string]$Command,
        [Parameter(ValueFromRemainingArguments = $true)]
        [string[]]$TfParams
    )

    # Terraformコマンドの絶対パス (scoop shim)
    $TerraformPath = "C:\Users\xiajl\scoop\shims\terraform.exe"

    if ($Command -eq 'init' -or $Command -eq 'plan' -or $Command -eq 'apply' -or $Command -eq 'destroy') {

        # ===== 新規: 引数リストを構築 =====
        $DefaultPlanFile = "planfile.tfplan"
        $FinalParams = [System.Collections.ArrayList]::new()
        if ($TfParams) { $TfParams | ForEach-Object { $FinalParams.Add($_) | Out-Null } }

        # ===== 新規: plan時 -out 自動付与 =====
        $IsPlan = $Command -eq 'plan'
        $HasOutOption = ($FinalParams | Where-Object { $_ -match '^-out=' -or $_ -eq '-out' }).Count -gt 0
        $NeedsOutOption = $IsPlan -and -not $HasOutOption
        if ($NeedsOutOption) {
            $FinalParams.Add("-out=$DefaultPlanFile") | Out-Null
            Write-Host "[INFO] -out=$DefaultPlanFile を自動付与しました" -ForegroundColor Cyan
        }

        # ===== 新規: apply時 tfplan 自動検出 =====
        $IsApply = $Command -eq 'apply'
        $HasPlanFile = ($FinalParams | Where-Object { $_ -match '\.tfplan$' }).Count -gt 0
        $NeedsPlanFile = $IsApply -and -not $HasPlanFile
        $LatestPlanFile = if ($NeedsPlanFile) {
            Get-ChildItem -Path . -Filter "*.tfplan" -File -ErrorAction SilentlyContinue |
                Sort-Object LastWriteTime -Descending | Select-Object -First 1
        } else { $null }
        if ($LatestPlanFile) {
            $FinalParams.Add($LatestPlanFile.Name) | Out-Null
            Write-Host "[INFO] $($LatestPlanFile.Name) を自動検出しました" -ForegroundColor Cyan
        }

        # PowerShellの出力エンコーディングをデフォルトUTF-8に変更
        $DefaultEncoding = [Console]::OutputEncoding
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8

        # ログ記録開始
        $LogFile = "C:\Users\${env:USERNAME}\Documents\terraform_logs\tf_$(Get-Date -Format 'yyyyMMdd')_${PID}.log"
        Start-Transcript $LogFile -Append -IncludeInvocationHeader

        # Terraformバージョン情報を出力
        terraform --version -json | ConvertFrom-Json | Format-List

        # 実行コマンドと引数を出力
        $ParamArray = $FinalParams.ToArray()
        $CommandLine = "terraform $Command $($ParamArray -join ' ')"
        Write-Output "実行コマンド:`n$CommandLine`n"

        # コマンド実行開始時刻記録
        $StartTime = Get-Date

        # Terraformコマンド実行
        & $TerraformPath $Command $ParamArray | Out-Default

        # ===== 新規: plan後 tfplan ファイル情報出力 =====
        $OutArg = $ParamArray | Where-Object { $_ -match '^-out=(.+)$' } | Select-Object -First 1
        $PlanFilePath = if ($OutArg -match '^-out=(.+)$') { $Matches[1] } else { $null }
        $ShowPlanInfo = $IsPlan -and $PlanFilePath -and (Test-Path $PlanFilePath)
        if ($ShowPlanInfo) {
            $PlanFileInfo = Get-Item $PlanFilePath
            Write-Output "`n----- Plan File Info -----"
            Write-Output "PATH        : $($PlanFileInfo.FullName)"
            Write-Output "SIZE        : $($PlanFileInfo.Length) bytes"
            Write-Output "UPDATED     : $($PlanFileInfo.LastWriteTime.ToString('yyyy/MM/dd HH:mm:ss'))"
            Write-Output "--------------------------"
        }

        # コマンド実行時間算出
        $EndTime = Get-Date
        $ExecutionTime = New-TimeSpan -Start $StartTime -End $EndTime
        $FormattedExecutionTime = "{0} 時間 {1} 分 {2} 秒" -f `
            $ExecutionTime.Hours, $ExecutionTime.Minutes, $ExecutionTime.Seconds
        Write-Output "`nコマンド実行時間: $FormattedExecutionTime"

        # ログ記録停止
        Stop-Transcript

        # PowerShellの出力エンコーディングをデフォルトに戻す
        [Console]::OutputEncoding = $DefaultEncoding
    }
    else {
        # 通常のTerraformコマンドを実行 (ログを記録しない)
        & $TerraformPath $Command $TfParams
    }
}

# エイリアスを設定
Set-Alias tf Terraform
